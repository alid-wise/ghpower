<%args>
	$dbh
	$id => undef
	$date => undef
</%args>
<%init>
use POSIX;
use locale;
use Time::Local;
setlocale(&LC_COLLATE, 'ru_RU.KOI8-R');

#my $login = $ENV{REMOTE_USER} || '-';

map { $_ =~ s/\D//g; } ( $id);
map { $_ = 0 if($_ > 100000) } ($id);
return unless $id;

unless($date =~ /\d{4}-\d{2}-\d{2}/) {
	my ($mday,$mon,$year) = (localtime)[3,4,5];
	$date = sprintf("%4d-%02d-%02d",$year+1900,$mon+1,$mday);
}

my ($mday,$mon,$year);
if($date =~ /(\d{4})-(\d{2})-(\d{2})/) {
	($mday,$mon,$year) = ($3,$2,$1);
}
my $TM = timelocal(0,0,0,$mday,$mon-1,$year-1900);
($mday,$mon,$year) = (localtime($TM-86400))[3,4,5];
my $prev = sprintf("%4d-%02d-%02d",$year+1900,$mon+1,$mday);
my $next;
unless($TM+86400 > time()) {
	($mday,$mon,$year) = (localtime($TM+86400))[3,4,5];
	$next = sprintf("%4d-%02d-%02d",$year+1900,$mon+1,$mday);
}

my $inf = $dbh->prepare("select counters.mgroup,counters.name,counters.addr,counters.mgroup,counters.sn,counters.model,counters.setdate,counters.memo,counters.active,counters.modtime,counters.year,counters.house,counter_type.name as model,street.name as street,towers.name as tower from counters inner join counter_type on counter_type.id=model left outer join street on street.id=counters.street left outer join towers on towers.id=counters.tower_id where counters.id=?");
$inf->execute($id);
my $Info = $inf->fetchrow_hashref;
$inf->finish;
# Этот счетчик - балансный?
$inf = $dbh->prepare("select * from mgroup where active=1 and bid=?");
$inf->execute($id);
my $h = $inf->fetchrow_hashref;
$inf->finish;
if($h) {
	($Info->{mgid},$Info->{gname}) = ($h->{id},$h->{name});
}

my $Data;

my $sth = $dbh->prepare("select to_timestamp(monitor.date::double precision) AS tm,se1ai,se2ai,ise from monitor where counter=? and cast(to_timestamp(monitor.date::double precision) as date)=? order by date desc");
$sth->execute($id,$date);
while(my $row = $sth->fetchrow_hashref) {
	$row->{tm} =~ s/\+\d+$//;
	$row->{tm} =~ s/^.*\s+//;
	map { $_ =sprintf("%0.3f",$_); s/\./\,/;} ($row->{ise},$row->{se1ai},$row->{se2ai});
	push @$Data, $row;
}
</%init>
<p><a href="index.html">Home</a></p>
<table border="0">
<tr><td align="right">Адрес:</td><td><%$Info->{street}%>, <%$Info->{house}%></td></tr>
</table>
%if($Info->{mgid}) {
<p>Это балансный счетчик</p>
%}
<h3><a href="?id=<%$id%>&date=<%$prev%>"><<</a>&nbsp;<%$date%>&nbsp;<% $next ? "<a href=?id=".$id."&date=".$next.">>></a>":""%></h3>
<table border="0">
<tr>
<td valign="top">
%if($Data) {
<table border="1">
<tr><th>Время</th><th>&nbsp;Тариф-1&nbsp;</th><th>&nbsp;Тариф-2&nbsp;</th><th>&nbsp;Ср.потр.&nbsp;</th></tr>
%foreach my $row (@$Data) {
<tr>
<td><b><% $row->{tm} %></b></td>
<td align="right"><%$row->{se1ai}%></td>
<td align="right"><%$row->{se2ai}%></td>
<td align="right"><%$row->{ise}%></td>
</tr>
%}
</table>
%} else {
<p>Нет данных на этот день</p>
%}
</td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
<td valign="top">



<table border="0">
<tr><td align="right">Тип:</td><td><%$Info->{model}%></td></tr>
<tr><td align="right">Серийный номер:</td><td><%$Info->{sn}%></td></tr>
<tr><td align="right">Год выпуска:</td><td><%$Info->{year}%></td></tr>
<tr><td align="right">Дата установки:</td><td><%$Info->{setdate}%></td></tr>
<tr><td align="right">Номер столба:</td><td><%$Info->{tower}%></td></tr>
<tr><td align="right">Доп.информация:</td><td><%$Info->{memo}%></td></tr>
</table>
<br>
<img src="graph/<%$Info->{mgroup}%>/<%$id%>-day.png">
<br>
<img src="graph/<%$Info->{mgroup}%>/<%$id%>-yesterday.png">
<br>
<img src="graph/<%$Info->{mgroup}%>/<%$id%>-week.png">
<br>
<img src="graph/<%$Info->{mgroup}%>/<%$id%>-month.png">
<br>
<img src="graph/<%$Info->{mgroup}%>/<%$id%>-3month.png">
<br>
<img src="graph/<%$Info->{mgroup}%>/<%$id%>-year.png">
%if($Info->{mgid}) {
<br>
<img src="graph/<%$Info->{mgid}%>/balance-day.png">
<br>
<img src="graph/<%$Info->{mgid}%>/balance-yesterday.png">
<br>
<img src="graph/<%$Info->{mgid}%>/balance-week.png">
<br>
<img src="graph/<%$Info->{mgid}%>/balance-month.png">
<br>
<img src="graph/<%$Info->{mgid}%>/balance-3month.png">
<br>
<img src="graph/<%$Info->{mgid}%>/balance-year.png">




%}


</td>
</tr>
</table>
