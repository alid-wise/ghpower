<%args>
	$dbh
	$auth
	$id => undef
</%args>
<%init>
use Data::Dumper;
#use POSIX;

if($auth->{gid} ne '1' && $auth->{gid} ne '2') {	# admin или manager
	$r->status_line('');
	$m->clear_buffer;
	$m->abort(404);
}
my $self = 'b_tariff.html';

if($ARGS{cancel}) {
	if($id || $ARGS{add_new}) {
		$r->status_line('');
		$m->clear_buffer;
		$m->redirect($self);
	} else {
		$r->status_line('');
		$m->clear_buffer;
		$m->abort(200);
	}
}

map { $_ =~ s/\D//g; } ( $id );

my %b_tariff_type = $m->comp("lib.msn:b_tariff_type");

my %Err;

if($ARGS{submit}) {

	my ($name,$type,$edate,$amount,$memo);
	$type = $ARGS{type};
	unless(exists $b_tariff_type{$type}) { $Err{type}++; }
	$name = $ARGS{name};
	$memo = $ARGS{memo};

	if($ARGS{edate} =~ /(\d{1,2})[\-\.](\d{1,2})[\-\.](\d{4})/) {
		$edate = sprintf("%d-%02d-%02d",$3,$2,$1);
	} else {
		$Err{edate}++;
	}
	map { $_ =~ s/\s//g; } ( $ARGS{amount} );

	if($ARGS{amount} =~ /(\d+)[\.\,]*(\d*)/) {
		$amount = $1.($2 ? ".$2":"");
	} else  {
		$Err{amount}++;
	}
	if($id) { 	# Редактируем запись

		if($ARGS{drop}) { # Удаляем запись
			my $del = $dbh->prepare("delete from b_tariff where id=? and sdate is null");
			$del->execute($id);
			$r->status_line('');
			$m->clear_buffer;
			$m->redirect($self);
		} else {
			my $sth = $dbh->prepare("SELECT auth,name,amount,type,edate,sdate,memo,modtime FROM b_tariff WHERE id=? LIMIT 1");
			$sth->execute($id);
			my ($b_auth,$b_name,$b_amount,$b_type,$b_edate,$b_sdate,$b_memo) = $sth->fetchrow_array;
			$sth->finish;
			if($b_sdate) {		# Править можно только название и комментарий
				my $upd = $dbh->prepare("update b_tariff set auth=$auth->{id},modtime=now(),name=?,memo=? where id=?");
				$upd->execute($name,$memo,$id);
				$r->status_line('');
				$m->clear_buffer;
				$m->redirect($self);
			} else {
				unless(%Err) {
					my $upd = $dbh->prepare("update b_tariff set auth=$auth->{id},modtime=now(),name=?,type=?,edate=?,amount=?,memo=? where id=?");
					$upd->execute($name,$type,$edate,$amount,$memo,$id);




					$r->status_line('');
					$m->clear_buffer;
					$m->redirect($self);
				}
			}
		}
	} else { # Новая запись
		my $ins = $dbh->prepare("insert into b_tariff (auth,name,type,amount,edate,memo) values ($auth->{id},?,?,?,?,?)");
		unless(%Err) {
			$ins->execute($name,$type,$amount,$edate,$memo);
#			undef $ARGS{add_new};
			$r->status_line('');
			$m->clear_buffer;
			$m->redirect($self);
		}
	}




} else {

	# Не нажата ли кнопка "начислить"?
	foreach my $accept (keys %ARGS) {
		if($accept =~ m/^accept_(\d+)$/) {
			my $aid = $1;
			my $ret = $m->comp("lib.msn:set_fee",dbh=>$dbh,bid=>$aid, auth=>$auth->{id}, verb=>0);
			if($ret) {  	# Ошибки?
				$m->out("<h1>ERROR</h1><pre>\n");
				foreach my $err (keys %$ret) {
					$m->out("$err\n");
					foreach my $s (@{$ret->{$err}}) {
						$m->out("$s\n");
					}
				}
				$m->out("</pre>\n");
				return();
			}
			last;
		}
	}
}

my $T;
my $sth = $dbh->prepare("SELECT id,auth,name,amount,type,edate,sdate,memo,modtime FROM b_tariff ORDER BY id DESC");
$sth->execute();
while(my $r = $sth->fetchrow_hashref) { $T->{$r->{id}} = $r; }
$sth->finish;

</%init>
<script src="calendar.js" type="text/javascript"></script>

%#<pre>
%#<%Dumper %ARGS%>
%#</pre>

%if($id || $ARGS{add_new}) {

<form method=POST>
<table border="1">
<tr><td colspan="2" align="right"><input class="close" type="submit" name="cancel" value="X"></td></tr>
<tr>
<td>Название:</td>
<td><input type="text" name="name" value="<% $ARGS{name} || ($ARGS{submit} ? "":$T->{$id}->{name}) %>"></td>
</tr>
<tr>
<td><div style=color:<% $Err{type} ? "red":"black"%>>Тип:</div></td>
<td><select name="type" <% $T->{$id}->{sdate} ? "disabled":"" %>>
%foreach(sort keys %b_tariff_type) {
%	my $tp = (defined $ARGS{type}) ? $ARGS{type} : $T->{$id}->{type};
	<option value="<% $_ %>" <% $tp eq $_ ? "selected":"" %>><% $b_tariff_type{$_} %></option>
%}
</select></td>
</tr>
<tr>
<td><div style=color:<% $Err{amount} ? "red":"black"%>>Сумма:</div></td>
<td><input type="text" name="amount" value="<% (defined $ARGS{amount}) ? $ARGS{amount} : ($ARGS{submit} ? "":$T->{$id}->{amount}) %>" <% $T->{$id}->{sdate} ? "disabled":"" %>></td>
</tr>
<tr>
<td><div style=color:<% $Err{edate} ? "red":"black"%>>Дата погашения:</div></td>
<td><input type="text" name="edate" value="<% $ARGS{edate} || $m->comp("lib.msn:pretty_date",date=>$T->{$id}->{edate}) || "dd.mm.yyyy"%>" onfocus="this.select();_Calendar.lcs(this)" onclick="event.cancelBubble=true;this.select();_Calendar.lcs(this)" <% $T->{$id}->{sdate} ? "disabled":"" %>></td>
</tr>
<tr>
<td>Примечания:</td>
<td align="center"><input type="text" name="memo" value="<% $ARGS{memo} || ($ARGS{submit} ? "":$T->{$id}->{memo}) %>"></td>
</tr>
<tr>
<td>Дата начисления:</td>
%#<td align="center"><input type="checkbox" name="accept" <% $ARGS{accept} ? "checked":"" %> <% $T->{$id}->{sdate} ? "checked disabled":"" %>></td>
<td align="center"><% $m->comp("lib.msn:pretty_date",date=>$T->{$id}->{sdate}) %></tr>
<tr>
%if($ARGS{add_new} || ($T->{$id}->{sdate})) {
	<td colspan="2" align="center"><nobr><input type="submit" name="submit" value="Сохранить"></nobr></td>
	<input type="hidden" name="add_new" value="1">
%} else {
	<td colspan="2" align="center"><nobr><input type="checkbox" name="drop">удалить&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" name="submit" value="OK"></nobr></td>
%}
</tr>
%if($id) {
<tr>
<td colspan=2 align=right><small>modtime: <%$T->{$id}->{modtime} =~ /(.+)\.\d+/%></small></td>
</tr>
%}
</table>
</form>
%} else {

<form method=POST>
<input type="submit" name="add_new" value="добавить" title="добавить">
<p><br></p>
%}
<table>
<tr><th>No</th><th>Дата погашения</th><th>Название</th><th>Тип</th><th>Сумма</th><th>Дата начисления</th></tr>
%foreach my $tid (sort { $T->{$b}->{edate} cmp $T->{$a}->{edate}} keys %{$T}) {
%	next unless $tid;
<tr>
<td><% $tid %></td>
<td><% $m->comp("lib.msn:pretty_date",date=>$T->{$tid}->{edate}) %></td>
<td><a href="?id=<% $T->{$tid}->{id} %>"><% $T->{$tid}->{name} || "-" %></a></td>
<td><% $b_tariff_type{$T->{$tid}->{type}} %></td>
<td align="right"><b><% $m->comp("lib.msn:pretty", value=>sprintf("%0.2f",$T->{$tid}->{amount})) %></b></td>
<td><% $T->{$tid}->{sdate} ? $m->comp("lib.msn:pretty_date",date=>$T->{$tid}->{sdate}) : "<input type=\"submit\" name=\"accept_".$tid."\" value=\"начислить\">" %></td>

%}
</table>
</form>

