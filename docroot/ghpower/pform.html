<%args>
	$dbh
	$auth
	$id => undef
	$list => undef
</%args>
<%init>
use Data::Dumper;
use POSIX;
use locale;
setlocale(&LC_COLLATE, 'ru_RU.KOI8-R');

if($auth->{gid} ne '1' && $auth->{gid} ne '2') {	# admin или manager
	$r->status_line('');
	$m->clear_buffer;
	$m->abort(404);
}


if($ARGS{cancel}) {
	$r->status_line('');
	$m->clear_buffer;
	$m->abort(200);
}

map { $_ =~ s/\D//g; } ( $id );
map { $_ =~ s/[^\.\,\d]//g; } ( $ARGS{i_balance}, $ARGS{i_t1}, $ARGS{i_t2} );
#map { $_ = 0 unless $_; } ( $ARGS{i_balance}, $ARGS{i_t1}, $ARGS{i_t2} );

# Проезды (улицы)
my $S = $m->comp("lib.msn:listload", dbh=>$dbh, name=>'street', nocache=>0);
# Текущий тариф
my $T = $m->comp("lib.msn:tariff", dbh=>$dbh, nocache=>0);
# Счетчики
my $L = $m->comp("lib.msn:cflistload", dbh=>$dbh, nocache=>0);

my ($Usr, $C, $List);
my %Err;
my ($p_id,$p_date,$p_prev1,$p_prev2,$p_current1,$p_current2,$p_amount,$p_balance);

Label1:
foreach(keys %$L) {
	my @items = @{$L->{$_}->{items}};
	foreach my $item(@items) {
		if($item->{id} eq $id) {
			$Usr = $item;
			last;
		}
	}
}

if($list) {	# будем показывать историю платежей
	my $ls = $dbh->prepare("SELECT id,date,prev1,prev2,current1,current2,amount,balance,modtime FROM payments WHERE cid=? ORDER BY modtime DESC");
	$ls->execute($id);
	while(my $r = $ls->fetchrow_hashref) {
		push @$List, $r;
	}
	$ls->finish;
} else {

	# Последняя оплата
	my $gp = $dbh->prepare("SELECT id,date,prev1,prev2,current1,current2,amount,balance FROM payments WHERE cid=? ORDER BY modtime DESC LIMIT 1");
	$gp->execute($id);
	($p_id,$p_date,$p_prev1,$p_prev2,$p_current1,$p_current2,$p_amount,$p_balance) = $gp->fetchrow_array;
	$gp->finish;

	$Usr->{balance} = $p_balance || $ARGS{i_balance};

	# Последние показания счетчика
	$C = $m->comp("lib.msn:lastcounter", dbh=>$dbh, id=>$Usr->{id}, nocache=>0);

	unless($p_id) {	# первый платеж
		$Usr->{cost} = (($C->{t1} - $ARGS{i_1}) * $T->{t1} + ($C->{t2} - $ARGS{i_t2}) * $T->{t2});
	} else {
		$Usr->{cost} = (($C->{t1} - $p_current1) * $T->{t1} + ($C->{t2} - $p_current2) * $T->{t2});
	}
	$Usr->{deposit} = $Usr->{cost} - $Usr->{balance};

	if($ARGS{submit}) {
		$Err{i_t}++	if(($ARGS{i_t1} > $C->{t1}) || ($ARGS{i_t2} > $C->{t2}));
		$Err{amount}++	if(!$ARGS{amount} || $ARGS{amount} =~ /\D/);
		unless(%Err) {
			my $ins = $dbh->prepare("INSERT INTO payments (cid,date,prev1,prev2,current1,current2,amount,balance) VALUES (?,?,?,?,?,?,?,?)");
			if($p_id) {
				$ins->execute($id,$C->{tm},$p_current1,$p_current2,$C->{t1},$C->{t2},$ARGS{amount},$ARGS{amount} - $Usr->{deposit});
			} else {
				$ins->execute($id,$C->{tm},$ARGS{i_t1},$ARGS{i_t2},$C->{t1},$C->{t2},$ARGS{amount},$ARGS{amount} - $Usr->{deposit});
			}
			return;
		}
	}
}
</%init>
<pre>
%#<%Dumper $Usr%>
</pre>

<form method=POST>
<table border="1">
<tr><td colspan="4" align="right"><input type="submit" name="cancel" value="X"></td></tr>
<tr><td colspan="4" align="right"><b><%$S->{$Usr->{street}}->{name}%>, <%$Usr->{house}%></b></td></tr>
%if($list) {	# история платежей
<tr><th><i>Дата</i></th><th><i>Тариф-1</i></th><th><i>Тариф-2</i></th><th><i>Сумма платежа</i></th><th></th></tr>
%	foreach my $row (@$List) {
<tr>
<td><%$row->{date}%></td>
<td align="right"><%$row->{current1}%></td>
<td align="right"><%$row->{current2}%></td>
<td align="right"><%$row->{amount}%></td>
</tr>
%	}
%} else {
%unless($p_id) {	# это первая оплата
<tr>
<td align="right" colspan="2"><div style=color:<% $Err{i_t} ? "red":"black"%>>Начальные показания:</div></td>
<td align="right"><input type="text" name="i_t1" value="<% defined $ARGS{"i_t1"} ? $ARGS{"i_t1"} : $C->{t1}%>"></td>
<td align="right"><input type="text" name="i_t2" value="<% defined $ARGS{"i_t2"} ? $ARGS{"i_t2"} : $C->{t2}%>"></td>
</tr>
<tr><td align="right" colspan="2">Входной баланс:</td><td align="right" colspan="2"><input type="text" name="i_balance" value="<%$ARGS{"i_balance"}%>"> руб. 00 коп.</td></tr>
%}
<tr><td align="right" colspan="2">Дата:</td><td colspan="2"><%$C->{tm}%></td></tr>
<tr><td align="right" colspan="2">Текущие показания:</td><td align="right"><%$C->{t1}%></td><td align="right"><%$C->{t2}%></td></tr>
<tr><td align="right" colspan="2">Сумма:</td><td colspan="2" align="right"><% sprintf("%.02f", $Usr->{cost}) %></td></tr>
<tr><td align="right" colspan="2">Аванс:</td><td colspan="2" align="right"><% sprintf("%.02f", $Usr->{balance}) %></td></tr>
<tr><td align="right" colspan="2">Долг:</td><td colspan="2" align="right"><b><% sprintf("%.02f", $Usr->{deposit}>0 ? $Usr->{deposit} : 0) %></b></td></tr>
%#<tr><td align="right" colspan="2"><div style=color:<% $Err{amount} ? "red":"black"%>>Сумма платежа:</div></td><td colspan="2"><input type="text" name="amount" value="<%$ARGS{amount} || sprintf("%d",$Usr->{balance}+$Usr->{deposit})%>"> руб. 00 коп.</td></tr>
<tr><td align="right" colspan="2"><div style=color:<% $Err{amount} ? "red":"black"%>>Сумма платежа:</div></td><td colspan="2"><input type="text" name="amount" value="<%$ARGS{amount} || ''%>"> руб. 00 коп.</td></tr>
<tr><td colspan="4" align="right"><input type="submit" name="submit" value="Сохранить"></td></tr>
%}
</table>



</form>
