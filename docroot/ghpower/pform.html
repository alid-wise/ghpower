<%args>
	$dbh
	$auth
	$cid => undef
	$id => undef
#	$list => undef
</%args>
<%init>
use Data::Dumper;
use POSIX;
use locale;
#setlocale(&LC_COLLATE, 'ru_RU.KOI8-R');
use utf8;

if($auth->{gid} ne '1' && $auth->{gid} ne '2') {	# admin или manager
	$r->status_line('');
	$m->clear_buffer;
	$m->abort(404);
}

if($ARGS{cancel}) {
	$r->status_line('');
	$m->clear_buffer;
	$m->abort(200);
}

map { $_ =~ s/\D//g; } ( $id, $cid );
return undef	unless $cid;
map { $_ =~ s/[^\.\,\d]//g; } ( $ARGS{i_t1}, $ARGS{i_t2} );

# Текущая дата
my $Today = $m->comp("lib.msn:now", nocache=>1);

# Проезды (улицы)
my $S = $m->comp("lib.msn:listload", dbh=>$dbh, name=>'street', nocache=>0);
# Текущий тариф
my $T = $m->comp("lib.msn:tariff", dbh=>$dbh, nocache=>0);
# Счетчики
my $L = $m->comp("lib.msn:cflistload", dbh=>$dbh, nocache=>0);

my ($Usr, $C, $List);
my %Err;
my ($p_id,$p_date,$p_prev1,$p_prev2,$p_current1,$p_current2,$p_amount,$p_balance,$p_init,$p_modtime);

foreach(keys %$L) {
	my @items = @{$L->{$_}->{items}};
	foreach my $item(@items) {
		if($item->{id} eq $cid) {
			$Usr = $item;
			last;
		}
	}
}

# Последняя оплата
my $gp = $dbh->prepare("SELECT id,date,prev1,prev2,current1,current2,amount,balance,init,modtime FROM payments WHERE cid=? ORDER BY modtime DESC LIMIT 1");
$gp->execute($cid);
($p_id,$Usr->{p_date},$p_prev1,$p_prev2,$Usr->{p_se1},$Usr->{p_se2},$p_amount,$Usr->{p_balance},$p_init,$p_modtime) = $gp->fetchrow_array;
$gp->finish;

# Последние показания счетчика
$C = $m->comp("lib.msn:lastcounter", dbh=>$dbh, id=>$Usr->{id}, nocache=>1);
map {s/\,/\./} ($C->{t1},$C->{t2});

unless($p_id) {	# первый платеж
	$Usr->{cost} = (($C->{t1} - $ARGS{i_1}) * $T->{C}->{t1} + ($C->{t2} - $ARGS{i_t2}) * $T->{C}->{t2});
} else {
	$Usr->{flow1} = sprintf("%.02f", $Usr->{se1} - $Usr->{p_se1});
	$Usr->{flow2} = sprintf("%.02f", $Usr->{se2} - $Usr->{p_se2});
	# Сумма "К оплате" Добавить коэффициент
	$Usr->{cost} = $Usr->{flow1} * $T->{C}->{t1} + $Usr->{flow2} * $T->{C}->{t2};
	$Usr->{topay} = $Usr->{cost} - $Usr->{p_balance};
}

if($ARGS{submit}) {
	map { $_ =~ s/\,/\./g; } ( $ARGS{i_balance}, $ARGS{i_t1}, $ARGS{i_t2} );

	my $ins = $dbh->prepare("INSERT INTO payments (auth,cid,date,prev1,prev2,current1,current2,amount,balance,init,mdate) VALUES (?,?,?,?,?,?,?,?,?,?,?)");
	if($ARGS{init}) {	# начальная точка
		$p_balance = $ARGS{i_balance} || 0;
		if($p_balance =~ /\s*(\-*)\s*(\d+)[\.\,]*(\d*)/) {
				$p_balance = $1.$2.($3 ? ".$3":"");
		} else  {
				$Err{i_balance}++;
		}
		
		if($ARGS{i_date} =~ /(\d{1,2})[\-\.](\d{1,2})[\-\.](\d{4})/) {
			$p_date = sprintf("%d-%02d-%02d",$3,$2,$1);
		} else {
			$Err{i_date}++;
		}
		# Показания контрольного счетчика на эту дату
		my $E = $m->comp("lib.msn:getcounter_date", dbh=>$dbh, id=>$cid, date=>$p_date, nocache=>1);
		$Err{i_date}++	unless($E->{se1ai} && $E->{se2ai});
		unless(%Err) {

			# Проверить на дубли!!!!!!

			$ins->execute($auth->{id},$cid,$p_date,$ARGS{i_t1} || 0,$ARGS{i_t2} || 0, $E->{se1ai}, $E->{se2ai} ,$p_balance,$p_balance,1,$p_date);

			$m->out('<script type="text/javascript">parent.location.reload();</script>');
			return;

#			$r->status_line('');
#			$m->clear_buffer;
##			$m->redirect('pays.html');
#			$m->abort(200);
		}

	} else {			# Очередной платеж
		my $amount = $ARGS{amount};
		$amount =~ s/\,/\./g;
		$amount =~ s/\s//g;
		if($amount =~ /^(\d+)\.*(\d){0,2}$/) {
			my ($ctm) = ($C->{tm} =~ /(\d{4}\-\d{2}\-\d{2})/);
			$ins->execute($auth->{id},$cid,$Today->{today},$Usr->{p_se1},$Usr->{p_se2},$Usr->{se1},$Usr->{se2},$amount,$amount - $Usr->{cost} + $Usr->{p_balance},0,$ctm);
			$m->out('<script type="text/javascript">parent.location.reload();</script>');
			return;

#			$r->status_line('');
#			$m->clear_buffer;
##			$m->redirect('pays.html');
#			$m->abort(200);
		} else {
			$Err{amount}++;
		}
	}

} else {

#if($id) {

#} else {	# будем показывать историю платежей
	my $ls = $dbh->prepare("SELECT id,date,prev1,prev2,current1,current2,amount,balance,modtime FROM payments WHERE cid=? ORDER BY modtime DESC");
	$ls->execute($cid);
	while(my $r = $ls->fetchrow_hashref) {
		push @$List, $r;
	}
	$ls->finish;
#}


}
</%init>
<script src="calendar.js" type="text/javascript"></script>

<pre>
%#<%Dumper $Usr%>
%#<%Dumper %ARGS%>
</pre>

<form method=POST>
<table border="1">
<tr><td colspan="4" align="right"><input type="submit" name="cancel" value="X"></td></tr>
<tr><td colspan="4" align="right">
</td></tr>
<tr><td colspan="4" align="right"><b><%$S->{$Usr->{street}}->{name}%>, <%$Usr->{house}%></b></td></tr>

%#if($id) {
%unless($p_id) {	# это первая оплата
<tr>
<td align="right" colspan="2"><div style=color:<% $Err{i_t} ? "red":"black"%>>Показания старого счетчика:</div></td>
<td align="right"><input type="text" name="i_t1" value="<% defined $ARGS{"i_t1"} ? $ARGS{"i_t1"} : ""%>"></td>
<td align="right"><input type="text" name="i_t2" value="<% defined $ARGS{"i_t2"} ? $ARGS{"i_t2"} : ""%>"></td>
</tr>
<tr><td align="right" colspan="2"><div style=color:<% $Err{i_date} ? "red":"black"%>>Дата:</div></td><td colspan="2"><input type="text" name="i_date" value="<% $ARGS{i_date} || "dd.mm.yyyy"%>" onfocus="this.select();_Calendar.lcs(this)" onclick="event.cancelBubble=true;this.select();_Calendar.lcs(this)"></td></tr>
<tr><td align="right" colspan="2"><div style=color:<% $Err{i_balance} ? "red":"black"%>>Входной баланс:</div></td><td align="right" colspan="2"><input type="text" name="i_balance" value="<%$ARGS{"i_balance"}%>"></td></tr>
<input type="hidden" name="init" value="1">

%} else {
<tr><td align="right" colspan="2">Дата платежа:</td><td colspan="2"><% $Today->{pretty}%></td></tr>
<tr><td align="right" colspan="2">Дата последней оплаты:</td><td colspan="2"><% $m->comp("lib.msn:pretty_date", date=>$Usr->{p_date})%></td></tr>
<tr><td align="right" colspan="2">Дата снятия показаний:</td><td colspan="2"><%$C->{tm}%></td></tr>
<tr><td align="right" colspan="2">Текущие показания:</td><td align="right"><% $m->comp("lib.msn:pretty", value=>$Usr->{se1}) %></td><td align="right"><% $m->comp("lib.msn:pretty", value=>$Usr->{se2}) %></td></tr>
<tr><td align="right" colspan="2">Предыдущие показания:</td><td align="right"><% $m->comp("lib.msn:pretty", value=>$Usr->{p_se1}) %></td><td align="right"><% $m->comp("lib.msn:pretty", value=>$Usr->{p_se2}) %></td></tr>
<tr><td align="right" colspan="2">Расход:</td><td align="right"><% $m->comp("lib.msn:pretty", value=>$Usr->{flow1}) %></td><td align="right"><% $m->comp("lib.msn:pretty", value=>$Usr->{flow2}) %></td></tr>
<tr><td align="right" colspan="2">Стоимость:</td><td colspan="2" align="right"><% $m->comp("lib.msn:pretty", value=> sprintf("%.02f", $Usr->{cost})) %></td></tr>
<tr><td align="right" colspan="2">Остаток:</td><td colspan="2" align="right"><% $m->comp("lib.msn:pretty", value=> sprintf("%.02f", $Usr->{p_balance})) %></td></tr>
<tr><td align="right" colspan="2">К оплате:</td><td colspan="2" align="right"><b><%  $m->comp("lib.msn:pretty", value=>($Usr->{topay} > 0)? sprintf("%.02f", $Usr->{topay}) : "0") %></b></td></tr>
<tr><td align="right" colspan="2"><div style=color:<% $Err{amount} ? "red":"black"%>>Сумма платежа:</div></td><td colspan="2"><input type="text" name="amount" value="<%$ARGS{amount} || ''%>"></td></tr>
%}
<tr><td colspan="4" align="right"><input type="submit" name="submit" value="Сохранить"></td></tr>
</table>
</form>



%if($p_id) {	#
<h3>История платежей</h3>
<table border="1">

<tr><th><i>Дата</i></th><th><i>Тариф-1</i></th><th><i>Тариф-2</i></th><th><i>Сумма платежа</i></th></tr>
%	foreach my $row (@$List) {
<tr>
<td><% $m->comp("lib.msn:pretty_date", date=>$row->{date}) %></td>
<td align="right"><% $m->comp("lib.msn:pretty", value=>$row->{current1}) %></td>
<td align="right"><% $m->comp("lib.msn:pretty", value=>$row->{current2}) %></td>
<td align="right"><% $m->comp("lib.msn:pretty", value=>$row->{amount}) %></td>
</tr>
%	}
</table>
%}


